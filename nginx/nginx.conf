worker_processes auto;

events {
    worker_connections 10240;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;

    upstream api_up {
        server library_api:8080;
    }

    upstream adminer_up {
        server adminer:8080;
    }

    server {
        listen 80;
        server_name _;

        root /var/www/project/static;

        location / {
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        location /reserved {
            return 301 /;
        }

        location /legacy {
            return 301 /api/v1;
        }

        location /documentation {
            try_files $uri $uri/ /README.html;
        }

        location /managment {
            try_files $uri /managment.html =404;
        }

        location /status {
            try_files $uri /status.html =404;
        }

        location /static/ {
            alias /var/www/project/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location /api/ {
            proxy_pass http://api_up;
        }

        location /admin {
            proxy_pass http://adminer_up/;
        }

        location /nginx_status {
            stub_status;
            allow all;
            access_log off;
        }
    }
}